{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "investment_memo.schema.json",
  "title": "Investment Memo Output",
  "type": "object",
  "required": ["sections", "references", "meta"],
  "properties": {
    "sections": {
      "type": "array",
      "minItems": 2,
      "items": {
        "type": "object",
        "required": ["key", "title", "content"],
        "properties": {
          "key": {"type": "string"},
          "title": {"type": "string"},
          "content": {"type": "string"},
          "citations": {"type": "array", "items": {"type": "string"}},
          "confidence": {"type": "number", "minimum": 0.0, "maximum": 1.0, "description": "Confidence score 0.0 - 1.0 (preferred numeric)."}
        }
      }
    },
    "financials": {
      "type": "object",
      "properties": {
        "historical": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["year", "citation"],
            "properties": {
              "year": {"type": "integer"},
              "revenue": {"type": ["string", "number"]},
              "ebitda": {"type": ["string", "number"]},
              "margin": {"type": ["string", "number"]},
              "citation": {"type": ["string", "array"], "items": {"type": "string"}}
            }
          }
        },
        "metrics": {
          "type": "object",
          "properties": {
            "rev_cagr": {"type": ["string", "number"]},
            "ebitda_margin_latest": {"type": ["string", "number"]},
            "citation": {"type": "array", "items": {"type": "string"}}
          }
        }
      }
    },
    "valuation": {
      "type": "object",
      "properties": {
        "base_case": {"$ref": "#/$defs/valuation_case"},
        "upside_case": {"$ref": "#/$defs/valuation_case"},
        "downside_case": {"$ref": "#/$defs/valuation_case"}
      }
    },
    "risks": {
      "type": "array",
      "items": {"$ref": "#/$defs/risk_item"}
    },
    "opportunities": {
      "type": "array",
      "items": {"$ref": "#/$defs/opportunity_item"}
    },
    "management": {
      "type": "object",
      "properties": {
        "summary": {"type": "string"},
        "strengths": {"type": "array", "items": {"type": "string"}},
        "gaps": {"type": "array", "items": {"type": "string"}},
        "citations": {"type": "array", "items": {"type": "string"}}
      }
    },
    "esg": {
      "type": "object",
      "properties": {
        "factors": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["dimension", "status"],
            "properties": {
              "dimension": {"type": "string"},
              "status": {"type": "string", "enum": ["Positive", "Neutral", "Negative"]},
              "citation": {"type": "string"}
            }
          }
        },
        "overall": {"type": "string"}
      }
    },
    "next_steps": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["priority", "action", "owner"],
        "properties": {
          "priority": {"type": "integer"},
          "action": {"type": "string"},
          "owner": {"type": "string"},
          "timeline_days": {"type": "integer"}
        }
      }
    },
    "inconsistencies": {
      "type": "array",
      "items": {"type": "string"}
    },
    "references": {"type": "array", "items": {"type": "string"}},
    "meta": {
      "type": "object",
      "required": ["version"],
      "properties": {"version": {"type": "integer", "const": 2}}
    }
  },
  "$defs": {
    "valuation_case": {
      "type": "object",
      "required": ["ev", "multiple"],
      "properties": {
        "ev": {"type": ["string", "number"]},
        "multiple": {"type": ["string", "number"]},
        "irr": {"type": ["string", "number"]},
        "assumptions": {"type": "string"},
        "citations": {"type": "array", "items": {"type": "string"}}
      }
    },
    "risk_item": {
      "type": "object",
      "required": ["description", "category", "severity"],
      "properties": {
        "description": {"type": "string"},
        "category": {"type": "string"},
        "severity": {"type": "string", "enum": ["Low", "Medium", "High", "Critical"]},
        "citations": {"type": "array", "items": {"type": "string"}}
      }
    },
    "opportunity_item": {
      "type": "object",
      "required": ["description", "category", "impact"],
      "properties": {
        "description": {"type": "string"},
        "category": {"type": "string"},
        "impact": {"type": "string", "enum": ["Low", "Medium", "High"]},
        "citations": {"type": "array", "items": {"type": "string"}}
      }
    }
  }
}
