{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "financial_model.schema.json",
  "title": "Financial Model Builder Output",
  "type": "object",
  "required": ["historical", "assumptions", "projections", "valuation", "key_drivers", "meta"],
  "properties": {
    "historical": {
      "type": "object",
      "required": ["revenue", "ebitda"],
      "properties": {
        "revenue": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["year", "value", "citation"],
            "properties": {
              "year": {"type": "integer"},
              "value": {"type": ["string", "number"]},
              "growth_rate": {"type": ["string", "number"]},
              "citation": {"type": "string"}
            }
          }
        },
        "ebitda": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["year", "value", "citation"],
            "properties": {
              "year": {"type": "integer"},
              "value": {"type": ["string", "number"]},
              "margin": {"type": ["string", "number"]},
              "citation": {"type": "string"}
            }
          }
        },
        "key_metrics": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "required": ["value", "citation"],
            "properties": {
              "value": {"type": ["string", "number"]},
              "citation": {"type": "string"}
            }
          }
        }
      }
    },
    "assumptions": {
      "type": "object",
      "required": ["base_case"],
      "properties": {
        "base_case": {"$ref": "#/$defs/scenario_assumptions"},
        "upside_case": {"$ref": "#/$defs/scenario_assumptions"},
        "downside_case": {"$ref": "#/$defs/scenario_assumptions"}
      }
    },
    "projections": {
      "type": "object",
      "required": ["base_case"],
      "properties": {
        "base_case": {"$ref": "#/$defs/projection_array"},
        "upside_case": {"$ref": "#/$defs/projection_array"},
        "downside_case": {"$ref": "#/$defs/projection_array"}
      }
    },
    "valuation": {
      "type": "object",
      "required": ["base_case"],
      "properties": {
        "base_case": {"$ref": "#/$defs/valuation_case"},
        "upside_case": {"$ref": "#/$defs/valuation_case"},
        "downside_case": {"$ref": "#/$defs/valuation_case"}
      }
    },
    "sensitivity_analysis": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["variable", "impact_on_irr", "range_tested"],
        "properties": {
          "variable": {"type": "string"},
          "impact_on_irr": {"type": "string"},
          "impact_on_moic": {"type": "string"},
          "range_tested": {"type": "string"}
        }
      }
    },
    "key_drivers": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["driver", "description", "impact"],
        "properties": {
          "driver": {"type": "string"},
          "description": {"type": "string"},
          "impact": {"type": "string", "enum": ["High", "Medium", "Low"]},
          "citation": {"type": "array", "items": {"type": "string"}}
        }
      }
    },
    "risks_to_model": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["risk", "probability", "impact_on_projections"],
        "properties": {
          "risk": {"type": "string"},
          "probability": {"type": "string", "enum": ["High", "Medium", "Low"]},
          "impact_on_projections": {"type": "string"},
          "mitigation": {"type": "string"}
        }
      }
    },
    "meta": {
      "type": "object",
      "required": ["version", "projection_years", "base_year"],
      "properties": {
        "version": {"type": "integer", "const": 1},
        "projection_years": {"type": "integer", "minimum": 3, "maximum": 10},
        "base_year": {"type": "integer"}
      }
    }
  },
  "$defs": {
    "scenario_assumptions": {
      "type": "object",
      "required": ["revenue_cagr", "ebitda_margin_target", "citation"],
      "properties": {
        "revenue_cagr": {"type": ["string", "number"]},
        "ebitda_margin_target": {"type": ["string", "number"]},
        "capex_percent_revenue": {"type": ["string", "number"]},
        "nwc_percent_revenue": {"type": ["string", "number"]},
        "citation": {"type": "array", "items": {"type": "string"}}
      }
    },
    "projection_array": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["year", "revenue", "ebitda", "ebitda_margin"],
        "properties": {
          "year": {"type": "integer"},
          "revenue": {"type": ["string", "number"]},
          "ebitda": {"type": ["string", "number"]},
          "ebitda_margin": {"type": ["string", "number"]},
          "fcf": {"type": ["string", "number"]},
          "citation": {"type": "array", "items": {"type": "string"}}
        }
      }
    },
    "valuation_case": {
      "type": "object",
      "required": ["exit_multiple", "exit_ev", "irr"],
      "properties": {
        "exit_multiple": {"type": ["string", "number"]},
        "exit_ev": {"type": ["string", "number"]},
        "irr": {"type": ["string", "number"]},
        "moic": {"type": ["string", "number"]},
        "investment_amount": {"type": ["string", "number"]},
        "citation": {"type": "array", "items": {"type": "string"}}
      }
    }
  }
}
