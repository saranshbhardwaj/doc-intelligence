{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "investment_memo.schema.json",
  "title": "Investment Memo Output - Version 2",
  "type": "object",
  "required": ["currency", "sections", "risks", "opportunities", "references", "meta"],
  "additionalProperties": false,
  "properties": {
    "currency": {
      "type": "string",
      "enum": ["USD", "EUR", "GBP", "JPY", "CNY", "CHF", "AUD", "CAD", "UNKNOWN"],
      "description": "Currency detected from financial documents"
    },
    "sections": {
      "type": "array",
      "minItems": 12,
      "maxItems": 13,
      "items": {
        "type": "object",
        "required": ["key", "title", "content"],
        "additionalProperties": false,
        "properties": {
          "key": {
            "type": "string",
            "enum": [
              "executive_overview",
              "company_overview",
              "market_competition",
              "financial_performance",
              "unit_economics",
              "track_record_value_creation",
              "risks",
              "opportunities",
              "management_culture",
              "esg_snapshot",
              "valuation_scenarios",
              "next_steps",
              "inconsistencies"
            ]
          },
          "title": {"type": "string"},
          "content": {
            "type": "string",
            "minLength": 50,
            "maxLength": 2000
          },
          "citations": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^\\[D\\d+:p\\d+\\]$"
            }
          },
          "confidence": {
            "type": "number",
            "minimum": 0.0,
            "maximum": 1.0,
            "description": "Optional confidence score - omit if uncertain"
          },
          "highlights": {
            "type": "array",
            "maxItems": 5,
            "items": {
              "type": "object",
              "required": ["type", "label", "value"],
              "properties": {
                "type": {
                  "type": "string",
                  "enum": ["company", "metric", "stat"]
                },
                "label": {"type": "string"},
                "value": {
                  "oneOf": [
                    {"type": "string"},
                    {"type": "number"}
                  ]
                },
                "formatted": {"type": "string"},
                "trend": {
                  "type": "string",
                  "enum": ["up", "down", "stable"]
                },
                "trend_value": {"type": "string"},
                "detail": {"type": "string"},
                "year": {"type": "integer"},
                "citation": {
                  "type": "string",
                  "pattern": "^\\[D\\d+:p\\d+\\]$"
                }
              }
            }
          },
          "key_metrics": {
            "type": "array",
            "maxItems": 6,
            "items": {
              "type": "object",
              "required": ["label", "value"],
              "properties": {
                "label": {"type": "string"},
                "value": {"type": "string"},
                "period": {"type": "string"},
                "status": {
                  "type": "string",
                  "enum": ["positive", "negative", "neutral", "strong", "weak", "monitor"]
                },
                "year": {"type": ["string", "integer"]},
                "citation": {
                  "type": "string",
                  "pattern": "^\\[D\\d+:p\\d+\\]$"
                }
              }
            }
          },
          "financials": {
            "type": "object",
            "description": "ONLY for financial_performance section",
            "required": ["currency", "historical"],
            "properties": {
              "currency": {
                "type": "string",
                "description": "Must match top-level currency"
              },
              "fiscal_year_end": {"type": "string"},
              "historical": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "object",
                  "required": ["year", "citation"],
                  "properties": {
                    "year": {"type": "integer", "minimum": 2000, "maximum": 2030},
                    "revenue": {"type": "number"},
                    "ebitda": {"type": "number"},
                    "margin": {"type": "number", "minimum": 0, "maximum": 1},
                    "citation": {
                      "oneOf": [
                        {"type": "string", "pattern": "^\\[D\\d+:p\\d+\\]$"},
                        {
                          "type": "array",
                          "items": {"type": "string", "pattern": "^\\[D\\d+:p\\d+\\]$"}
                        }
                      ]
                    }
                  }
                }
              },
              "metrics": {
                "type": "object",
                "properties": {
                  "rev_cagr": {"type": "number"},
                  "ebitda_margin_latest": {"type": "number"},
                  "citation": {
                    "type": "array",
                    "items": {"type": "string"}
                  }
                }
              }
            }
          }
        }
      }
    },
    "company_overview": {
      "type": "object",
      "properties": {
        "company_name": {"type": "string"},
        "industry": {"type": "string"},
        "headquarters": {"type": "string"},
        "founded": {"type": ["integer", "string"]},
        "description": {"type": "string"},
        "citations": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "risks": {
      "type": "array",
      "minItems": 0,
      "items": {"$ref": "#/$defs/risk_item"}
    },
    "opportunities": {
      "type": "array",
      "minItems": 0,
      "items": {"$ref": "#/$defs/opportunity_item"}
    },
    "management": {
      "type": "object",
      "required": ["summary"],
      "properties": {
        "summary": {"type": "string"},
        "key_people": {
          "type": "array",
          "maxItems": 5,
          "items": {
            "type": "object",
            "required": ["name", "title"],
            "properties": {
              "name": {"type": "string"},
              "title": {"type": "string"},
              "background": {"type": "string"},
              "tenure_years": {"type": "integer", "minimum": 0}
            }
          }
        },
        "strengths": {
          "type": "array",
          "items": {"type": "string"}
        },
        "gaps": {
          "type": "array",
          "items": {"type": "string"}
        },
        "citations": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "valuation": {
      "type": "object",
      "properties": {
        "base_case": {"$ref": "#/$defs/valuation_case"},
        "upside_case": {"$ref": "#/$defs/valuation_case"},
        "downside_case": {"$ref": "#/$defs/valuation_case"}
      }
    },
    "esg": {
      "type": "object",
      "properties": {
        "factors": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["dimension", "status"],
            "properties": {
              "dimension": {"type": "string"},
              "status": {
                "type": "string",
                "enum": ["Positive", "Neutral", "Negative"]
              },
              "citation": {"type": "string"}
            }
          }
        },
        "overall": {"type": "string"}
      }
    },
    "next_steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["priority", "action", "owner"],
        "properties": {
          "priority": {"type": "integer", "minimum": 1},
          "action": {"type": "string"},
          "owner": {"type": "string"},
          "timeline_days": {"type": "integer", "minimum": 0}
        }
      }
    },
    "inconsistencies": {
      "type": "array",
      "items": {"type": "string"}
    },
    "references": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^\\[D\\d+:p\\d+\\]$"
      },
      "uniqueItems": true
    },
    "meta": {
      "type": "object",
      "required": ["version"],
      "properties": {
        "version": {
          "type": "integer",
          "const": 2
        }
      }
    }
  },
  "$defs": {
    "valuation_case": {
      "type": "object",
      "required": ["ev", "multiple"],
      "properties": {
        "ev": {"type": "number"},
        "multiple": {"type": "number"},
        "irr": {"type": "number"},
        "assumptions": {"type": "string"},
        "citations": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "risk_item": {
      "type": "object",
      "required": ["description", "category", "severity"],
      "properties": {
        "description": {"type": "string"},
        "category": {"type": "string"},
        "severity": {
          "type": "string",
          "enum": ["Low", "Medium", "High", "Critical"]
        },
        "citations": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "opportunity_item": {
      "type": "object",
      "required": ["description", "category", "impact"],
      "properties": {
        "description": {"type": "string"},
        "category": {"type": "string"},
        "impact": {
          "type": "string",
          "enum": ["Low", "Medium", "High"]
        },
        "citations": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    }
  }
}